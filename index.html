<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>旅のしおりアプリ</title>

    <!-- Tailwind CSSの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome (アイコン) の読み込み -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- Google Fontsの読み込み -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=M+PLUS+Rounded+1c:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* カスタムスタイルの定義 */
        body {
            font-family: 'Inter', 'M PLUS Rounded 1c', sans-serif;
            overscroll-behavior: none; /* スワイプ時のブラウザの「戻る」機能を無効化 */
            overflow: hidden;
        }

        /* 進行中の予定をハイライトするアニメーション */
        .glowing-pulse {
            animation: glowing-pulse 2s infinite;
            box-shadow: 0 0 5px rgba(250, 204, 21, 0.8), 0 0 10px rgba(250, 204, 21, 0.6), 0 0 20px rgba(250, 204, 21, 0.4);
        }
        @keyframes glowing-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.02); opacity: 0.95; }
        }

        /* 背景のグラデーションアニメーション（シマー効果） */
        .shimmer-bg {
            background: linear-gradient(-45deg, #0f172a, #1e3a8a, #312e81, #0f172a); /* 背景色を暗い寒色系に変更 */
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* 画面遷移のアニメーション */
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transition: transform 0.4s ease-in-out;
            overflow-y: auto;
            padding-bottom: 80px; /* フッターナビゲーションの高さ分 */
        }
        .page-leave { transform: translateX(-100%); }
        .page-enter { transform: translateX(100%); }
        .page-active { transform: translateX(0); }
        .page-leave-reverse { transform: translateX(100%); }
        .page-enter-reverse { transform: translateX(-100%); }

        /* 天気予報ページとマップページ専用のフルスクリーン設定 */
        #weather-page, #map-page {
            padding-bottom: 0;
            overflow: hidden;
        }
        #weather-page .page-content, #map-page .page-content {
            height: calc(100vh - 80px); /* 画面全体 - ナビゲーションバーの高さ */
            display: flex;
            flex-direction: column;
        }

        #windy-container, #gmap-container {
            flex-grow: 1; /* コンテナをいっぱいに広げる */
            position: relative;
        }

        #windy-iframe, #gmap-iframe {
            width: 100%;
            height: 100%;
            border: 0;
        }
        
        .full-screen-iframe {
            width: 100vw;
            height: calc(100vh - 80px); /* ナビゲーションバーを除く全画面 */
        }
    </style>
</head>
<body class="shimmer-bg text-white antialiased overflow-hidden">

    <div id="app-container" class="relative w-full h-screen max-w-lg mx-auto bg-black bg-opacity-10 backdrop-blur-md overflow-hidden shadow-2xl">

        <!-- ===== メインページ ===== -->
        <div id="main-page" class="page page-active">
            <div class="p-4 space-y-4">
                <header class="text-center">
                    <h1 class="text-2xl font-bold">今日の旅程</h1>
                    <p id="current-time" class="text-sm opacity-80"></p>
                </header>
                <div id="current-status-card" class="bg-white/20 p-4 rounded-xl shadow-lg space-y-3 hidden">
                    <h2 class="font-bold text-lg flex items-center"><i class="fas fa-location-arrow mr-2"></i>現在の状況</h2>
                    <div class="space-y-2">
                        <p class="text-sm">
                            <span id="current-location">現在地</span> → <span id="next-station" class="font-bold">次の駅</span>
                        </p>
                        <div class="w-full bg-gray-200/50 rounded-full h-2.5">
                            <div id="progress-bar" class="bg-yellow-400 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div>
                        </div>
                        <div class="flex justify-between text-xs opacity-90">
                            <span id="departure-time-info">出発時刻</span>
                            <span id="arrival-time-info">到着予定: HH:MM</span>
                        </div>
                    </div>
                    <p id="line-info" class="text-sm bg-black/20 px-3 py-1 rounded-full text-center"><i class="fas fa-train mr-1"></i> 路線・ホーム情報</p>
                </div>
                <div id="next-event-card" class="bg-white/20 p-4 rounded-xl shadow-lg space-y-2">
                    <h2 class="font-bold text-lg flex items-center"><i class="fas fa-flag-checkered mr-2"></i>次の予定</h2>
                    <p id="next-event-title" class="text-xl">次の予定がありません</p>
                    <p id="next-event-time" class="text-sm opacity-80"></p>
                </div>
                <div class="space-y-3">
                    <h2 class="font-bold text-lg"><i class="fas fa-list-ul mr-2"></i>タイムライン</h2>
                    <div id="timeline-container" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- ===== スケジュール管理ページ ===== -->
        <div id="schedule-page" class="page page-enter">
            <div class="p-4 space-y-4">
                <h1 class="text-2xl font-bold text-center">スケジュール管理</h1>
                <div class="bg-white/20 p-4 rounded-xl shadow-lg space-y-3">
                    <h2 class="font-bold text-lg">新しい予定を追加</h2>
                    <input type="text" id="event-title" placeholder="予定のタイトル (例: 博物館見学)" class="w-full bg-black/20 border-0 rounded-md px-3 py-2 placeholder-white/50 focus:ring-2 focus:ring-yellow-400">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="time" id="event-start" class="w-full bg-black/20 border-0 rounded-md px-3 py-2">
                        <input type="time" id="event-end" class="w-full bg-black/20 border-0 rounded-md px-3 py-2">
                    </div>
                    <select id="event-type" class="w-full bg-black/20 border-0 rounded-md px-3 py-2">
                        <option value="fas fa-walking">🚶 徒歩</option>
                        <option value="fas fa-train">🚆 電車</option>
                        <option value="fas fa-bus">🚌 バス</option>
                        <option value="fas fa-utensils">🍽️ 食事</option>
                        <option value="fas fa-shopping-cart">🛍️ 買い物</option>
                        <option value="fas fa-camera">📷 観光</option>
                        <option value="fas fa-bed">🏨 宿泊</option>
                        <option value="fas fa-info-circle">📝 その他</option>
                    </select>
                    <textarea id="event-details" placeholder="詳細 (例: 路線情報、場所など)" class="w-full bg-black/20 border-0 rounded-md px-3 py-2 h-20 placeholder-white/50 focus:ring-2 focus:ring-yellow-400"></textarea>
                    <button id="add-event-btn" class="w-full bg-yellow-400 text-black font-bold py-2 rounded-md hover:bg-yellow-500 transition-colors">追加する</button>
                </div>
                <div class="space-y-3">
                    <h2 class="font-bold text-lg">予定一覧</h2>
                    <div id="schedule-list-container" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <!-- ===== マップページ ===== -->
        <div id="map-page" class="page page-enter">
            <div class="page-content">
                <div class="p-4 space-y-4">
                    <h1 class="text-2xl font-bold text-center"><i class="fas fa-map-marked-alt mr-2"></i>ルート確認</h1>
                </div>
                <div id="gmap-container" class="rounded-lg overflow-hidden shadow-lg">
                     <iframe id="gmap-iframe" class="w-full h-full border-0" allowfullscreen="" loading="lazy"></iframe>
                     <div id="map-placeholder" class="absolute inset-0 bg-white/20 flex items-center justify-center text-center p-4">
                        <p>Googleマイマップの埋め込みURLを<br>設定ページから入力してください。</p>
                     </div>
                </div>
            </div>
        </div>

        <!-- ===== 天気予報ページ ===== -->
        <div id="weather-page" class="page page-enter">
            <div class="page-content">
                <div class="p-4 space-y-4">
                    <h1 class="text-2xl font-bold text-center"><i class="fas fa-cloud-sun mr-2"></i>天気予報</h1>
                </div>
                <div id="windy-container" class="rounded-lg overflow-hidden shadow-lg">
                    <iframe id="windy-iframe" frameborder="0" loading="lazy"></iframe>
                    <div id="weather-placeholder" class="absolute inset-0 bg-white/20 flex items-center justify-center text-center p-4">
                        <p id="weather-placeholder-text">天気予報を読み込み中...</p>
                    </div>
                </div>
                <div class="text-center space-x-2 mt-4 p-4">
                    <button id="get-current-weather-btn" class="bg-yellow-400 text-black font-bold py-2 px-4 rounded-md hover:bg-yellow-500 transition-colors">現在地の天気</button>
                    <button id="get-settings-weather-btn" class="bg-sky-500 text-white font-bold py-2 px-4 rounded-md hover:bg-sky-600 transition-colors">設定地点の天気</button>
                </div>
            </div>
        </div>

        <!-- ===== ルート検索ページ ===== -->
        <div id="route-page" class="page page-enter">
             <div class="p-4 space-y-4">
                <h1 class="text-2xl font-bold text-center">交通ルート検索</h1>
                <div class="bg-white/20 p-4 rounded-xl shadow-lg space-y-3">
                    <input type="text" id="origin" placeholder="出発地 (例: 東京駅)" class="w-full bg-black/20 border-0 rounded-md px-3 py-2 placeholder-white/50 focus:ring-2 focus:ring-yellow-400">
                    <input type="text" id="destination" placeholder="目的地 (例: 新宿御苑)" class="w-full bg-black/20 border-0 rounded-md px-3 py-2 placeholder-white/50 focus:ring-2 focus:ring-yellow-400">
                    <button id="search-route-btn" class="w-full bg-yellow-400 text-black font-bold py-2 rounded-md hover:bg-yellow-500 transition-colors">ルートを検索</button>
                </div>
                <div id="route-results-container" class="space-y-2"></div>
                <div id="loading-indicator" class="hidden text-center py-4">
                    <i class="fas fa-spinner fa-spin text-2xl"></i>
                    <p>検索中...</p>
                </div>
             </div>
        </div>

        <!-- ===== 設定ページ ===== -->
        <div id="settings-page" class="page page-enter">
            <div class="p-4 space-y-4">
                <h1 class="text-2xl font-bold text-center">設定</h1>
                <div class="bg-white/20 p-4 rounded-xl shadow-lg space-y-3">
                    <h2 class="font-bold text-lg">Google Maps APIキー</h2>
                    <p class="text-xs opacity-80">ルート検索機能を利用するために、ご自身のAPIキーを設定してください。</p>
                    <input type="password" id="api-key-input" placeholder="APIキーを入力" class="w-full bg-black/20 border-0 rounded-md px-3 py-2 placeholder-white/50 focus:ring-2 focus:ring-yellow-400">
                    <h2 class="font-bold text-lg mt-4">GoogleマイマップURL</h2>
                    <p class="text-xs opacity-80">Googleマイマップで「サイトに埋め込む」を選択して表示されるHTMLから、src="... " のURL部分を貼り付けてください。</p>
                    <input type="url" id="gmap-url-input" placeholder="マイマップの埋め込みURL" class="w-full bg-black/20 border-0 rounded-md px-3 py-2 placeholder-white/50 focus:ring-2 focus:ring-yellow-400">
                    <h2 class="font-bold text-lg mt-4">天気予報地点</h2>
                    <p class="text-xs opacity-80">天気予報を表示したい地点を入力してください。（例: 東京都, 日本）</p>
                    <input type="text" id="weather-location-input" placeholder="地点を入力 (例: 東京都)" class="w-full bg-black/20 border-0 rounded-md px-3 py-2 placeholder-white/50 focus:ring-2 focus:ring-yellow-400">
                    <button id="save-settings-btn" class="w-full bg-yellow-400 text-black font-bold py-2 rounded-md hover:bg-yellow-500 transition-colors mt-4">設定を保存</button>
                </div>
                <div class="bg-white/20 p-4 rounded-xl shadow-lg space-y-3">
                    <h2 class="font-bold text-lg">データ管理</h2>
                    <button id="clear-data-btn" class="w-full bg-red-500 text-white font-bold py-2 rounded-md hover:bg-red-600 transition-colors">全てのスケジュールを削除</button>
                </div>
            </div>
        </div>
        
        <!-- モーダルダイアログ (confirm/alertの代替) -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 z-50">
            <div class="bg-white/90 backdrop-blur-md p-6 rounded-xl shadow-lg w-full max-w-sm text-black text-center space-y-4 relative">
                <p id="modal-message" class="text-lg"></p>
                <div id="modal-buttons" class="flex justify-center space-x-4">
                    <button id="modal-ok-btn" class="bg-yellow-400 px-4 py-2 rounded-md font-bold hover:bg-yellow-500 transition-colors">OK</button>
                    <button id="modal-cancel-btn" class="bg-gray-300 px-4 py-2 rounded-md font-bold hover:bg-gray-400 transition-colors">キャンセル</button>
                </div>
            </div>
        </div>

        <!-- フッターナビゲーション -->
        <nav class="absolute bottom-0 left-0 right-0 bg-black/30 backdrop-blur-sm p-2 flex justify-around">
            <button data-page="main-page" class="nav-btn text-yellow-400 flex flex-col items-center w-1/5">
                <i class="fas fa-home text-xl"></i>
                <span class="text-xs">ホーム</span>
            </button>
            <button data-page="schedule-page" class="nav-btn text-white/80 flex flex-col items-center w-1/5">
                <i class="fas fa-calendar-alt text-xl"></i>
                <span class="text-xs">スケジュール</span>
            </button>
            <button data-page="map-page" class="nav-btn text-white/80 flex flex-col items-center w-1/5">
                <i class="fas fa-map text-xl"></i>
                <span class="text-xs">マップ</span>
            </button>
            <button data-page="weather-page" class="nav-btn text-white/80 flex flex-col items-center w-1/5">
                <i class="fas fa-cloud-sun text-xl"></i>
                <span class="text-xs">天気</span>
            </button>
            <button data-page="route-page" class="nav-btn text-white/80 flex flex-col items-center w-1/5">
                <i class="fas fa-route text-xl"></i>
                <span class="text-xs">ルート</span>
            </button>
            <button data-page="settings-page" class="nav-btn text-white/80 flex flex-col items-center w-1/5">
                <i class="fas fa-cog text-xl"></i>
                <span class="text-xs">設定</span>
            </button>
        </nav>
    </div>

    <script>
        let schedule = [];
        let googleApiKey = '';
        let googleMapUrl = '';
        let weatherLocation = '';
        let directionsService;
        let geocoder;
        let currentPage = 'main-page';
        let isNavigating = false;
        let googleMapsLoaded = false;
        let modalResolve;
        
        // モーダルを閉じる関数
        function closeModal() {
            const modal = document.getElementById('modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }

        function showModal(message, isConfirm = false) {
            const modal = document.getElementById('modal');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');
            const okBtn = document.getElementById('modal-ok-btn');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            modalMessage.textContent = message;
            
            // 確認モーダルの場合はボタンを表示
            if (isConfirm) {
                modalButtons.classList.remove('hidden');
                okBtn.style.display = 'inline-block';
                okBtn.textContent = 'OK';
                cancelBtn.style.display = 'inline-block';
            } else {
                modalButtons.classList.remove('hidden'); // ボタンコンテナは常に表示
                okBtn.style.display = 'block';
                okBtn.textContent = '閉じる';
                cancelBtn.style.display = 'none';
            }

            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            
            return new Promise(resolve => {
                modalResolve = resolve;
                if (isConfirm) {
                    okBtn.onclick = () => {
                        closeModal();
                        resolve(true);
                    };
                    cancelBtn.onclick = () => {
                        closeModal();
                        resolve(false);
                    };
                } else {
                     okBtn.onclick = () => {
                        closeModal();
                    };
                }
            });
        }
        
        function initGoogleMaps() {
            if (googleApiKey && !googleMapsLoaded) {
                const script = document.createElement('script');
                script.src = `https://maps.googleapis.com/maps/api/js?key=${googleApiKey}&libraries=places&callback=onGoogleMapsLoaded`;
                document.head.appendChild(script);
                googleMapsLoaded = true;
            }
        }

        window.onGoogleMapsLoaded = function() {
            if (typeof google !== 'undefined') {
                directionsService = new google.maps.DirectionsService();
                geocoder = new google.maps.Geocoder();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            initGoogleMaps();
            renderAll();
            setupEventListeners();
            setInterval(updateRealtimeStatus, 1000);
            
            // ページ読み込み時にWindyとマップをロード
            loadWindy();
            renderMap();
        });

        function loadData() {
            const savedSchedule = localStorage.getItem('travelSchedule');
            if (savedSchedule) {
                schedule = JSON.parse(savedSchedule);
            } else {
                schedule = [
                    { id: 1, title: '羽田空港に到着', start: '09:00', end: '09:30', type: 'fas fa-plane-arrival', details: '第1ターミナル' },
                    { id: 2, title: 'リムジンバスで移動', start: '09:45', end: '10:30', type: 'fas fa-bus', details: '新宿駅西口行き' },
                    { id: 3, title: 'ホテルにチェックイン', start: '11:00', end: '11:30', type: 'fas fa-bed', details: '荷物を預ける' },
                ];
            }
            googleApiKey = localStorage.getItem('googleApiKey') || '';
            googleMapUrl = localStorage.getItem('googleMapUrl') || "https://www.google.com/maps/d/u/0/embed?mid=1W_k8BLKMwj87q0JcgqtTvvG2qFRJBpk&ehbc=2E312F&noprof=1";
            weatherLocation = localStorage.getItem('weatherLocation') || '';
            document.getElementById('api-key-input').value = googleApiKey;
            document.getElementById('gmap-url-input').value = googleMapUrl;
            document.getElementById('weather-location-input').value = weatherLocation;
        }

        function saveData() {
            localStorage.setItem('travelSchedule', JSON.stringify(schedule));
            localStorage.setItem('googleApiKey', googleApiKey);
            localStorage.setItem('googleMapUrl', googleMapUrl);
            localStorage.setItem('weatherLocation', weatherLocation);
        }
        
        function sortSchedule() {
            schedule.sort((a, b) => a.start.localeCompare(b.start));
        }

        function renderAll() {
            sortSchedule();
            renderTimeline();
            renderScheduleList();
            updateRealtimeStatus();
            renderMap();
        }

        function renderTimeline() {
            const container = document.getElementById('timeline-container');
            container.innerHTML = '';
            if (schedule.length === 0) {
                container.innerHTML = '<p class="text-center opacity-70">予定がありません。</p>';
                return;
            }
            const now = new Date();
            const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            schedule.forEach(event => {
                const isCurrent = currentTimeStr >= event.start && currentTimeStr < event.end;
                const isPast = currentTimeStr >= event.end;
                let cardClass = isCurrent ? 'bg-yellow-400/80 text-black glowing-pulse' : isPast ? 'bg-black/20 opacity-60' : 'bg-white/20';
                const item = document.createElement('div');
                item.className = `flex items-start space-x-3 p-3 rounded-xl transition-all ${cardClass}`;
                item.innerHTML = `<div class="flex flex-col items-center"><i class="${event.type} text-xl w-6 text-center"></i><div class="w-px h-full bg-white/50 flex-grow mt-1"></div></div><div><p class="font-bold">${event.start} - ${event.end}</p><h3 class="text-lg">${event.title}</h3>${event.details ? `<p class="text-sm opacity-80">${event.details}</p>` : ''}</div>`;
                container.appendChild(item);
            });
        }
        
        function renderScheduleList() {
            const container = document.getElementById('schedule-list-container');
            container.innerHTML = '';
            if (schedule.length === 0) {
                container.innerHTML = '<p class="text-center opacity-70">予定がありません。</p>';
                return;
            }
            schedule.forEach(event => {
                const item = document.createElement('div');
                item.className = 'bg-black/20 p-3 rounded-lg flex justify-between items-center';
                item.innerHTML = `<div><p class="font-bold">${event.start} - ${event.end} <i class="${event.type} ml-2"></i></p><p>${event.title}</p></div><button class="delete-event-btn text-red-400 hover:text-red-500" data-id="${event.id}"><i class="fas fa-trash-alt fa-lg"></i></button>`;
                container.appendChild(item);
            });
            document.querySelectorAll('.delete-event-btn').forEach(button => button.addEventListener('click', deleteEvent));
        }

        function renderMap() {
            const iframe = document.getElementById('gmap-iframe');
            const placeholder = document.getElementById('map-placeholder');
            if (googleMapUrl) {
                iframe.src = googleMapUrl;
                iframe.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                iframe.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        function loadWindy() {
            const iframe = document.getElementById('windy-iframe');
            const placeholder = document.getElementById('weather-placeholder');
            const placeholderText = document.getElementById('weather-placeholder-text');

            // ユーザー指定の埋め込みURLをセット
            const defaultSrc = `https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=mm&metricTemp=%C2%B0C&metricWind=m/s&zoom=8&overlay=radar&product=radar&level=surface&lat=35.142&lon=138.928&detailLat=35.489&detailLon=139.482&detail=true&pressure=true`;
            iframe.src = defaultSrc;

            // ローディング表示を消す
            iframe.onload = () => {
                placeholder.classList.add('hidden');
            };
        }
        
        function updateRealtimeStatus() {
            document.getElementById('current-time').textContent = new Date().toLocaleString('ja-JP');
            const now = new Date();
            const currentTimeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            let currentEvent = null;
            let nextEvent = schedule.find(event => currentTimeStr < event.start);
            for (const event of schedule) {
                if (currentTimeStr >= event.start && currentTimeStr < event.end) currentEvent = event;
            }

            const currentStatusCard = document.getElementById('current-status-card');
            if (currentEvent && /train|bus|plane|route/.test(currentEvent.type)) {
                currentStatusCard.classList.remove('hidden');
                const start = new Date(`${now.toDateString()} ${currentEvent.start}`);
                const end = new Date(`${now.toDateString()} ${currentEvent.end}`);
                if (end < start) end.setDate(end.getDate() + 1);
                const progress = Math.min(100, Math.max(0, (now - start) / (end - start) * 100));
                document.getElementById('progress-bar').style.width = `${progress}%`;
                const [origin, destination] = currentEvent.title.split('→');
                document.getElementById('current-location').textContent = origin ? origin.trim() : '出発地';
                document.getElementById('next-station').textContent = destination ? destination.trim() : '目的地';
                document.getElementById('departure-time-info').textContent = currentEvent.start;
                document.getElementById('arrival-time-info').textContent = `到着予定: ${currentEvent.end}`;
                document.getElementById('line-info').innerHTML = `<i class="${currentEvent.type} mr-1"></i> ${currentEvent.details || '詳細情報なし'}`;
            } else {
                currentStatusCard.classList.add('hidden');
            }
            
            const nextEventTitle = document.getElementById('next-event-title');
            const nextEventTime = document.getElementById('next-event-time');
            if (nextEvent) {
                nextEventTitle.textContent = nextEvent.title;
                nextEventTime.textContent = `${nextEvent.start} - ${nextEvent.end}`;
            } else if (currentEvent) {
                nextEventTitle.textContent = "現在進行中：" + currentEvent.title;
                nextEventTime.textContent = `${currentEvent.start} - ${currentEvent.end}`;
            } else {
                nextEventTitle.textContent = '次の予定はありません';
                nextEventTime.textContent = '';
            }
            renderTimeline();
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-btn').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.page)));
            document.getElementById('add-event-btn').addEventListener('click', addEvent);
            document.getElementById('search-route-btn').addEventListener('click', searchRoute);
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            document.getElementById('clear-data-btn').addEventListener('click', async () => {
                const confirmed = await showModal('本当にすべてのスケジュールを削除しますか？', true);
                if (confirmed) {
                    schedule = []; saveData(); renderAll();
                }
            });
            
            document.getElementById('get-current-weather-btn').addEventListener('click', () => loadWeatherByLocation(null, true));
            document.getElementById('get-settings-weather-btn').addEventListener('click', () => loadWeatherByLocation(weatherLocation, false));


            let touchstartX = 0;
            const appContainer = document.getElementById('app-container');
            appContainer.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; }, { passive: true });
            appContainer.addEventListener('touchend', e => { handleSwipe(touchstartX, e.changedTouches[0].screenX); }, { passive: true });
        }
            
        function handleSwipe(touchstartX, touchendX) {
            const pages = ['main-page', 'schedule-page', 'map-page', 'weather-page', 'route-page', 'settings-page'];
            const currentIndex = pages.indexOf(currentPage);
            if (touchendX < touchstartX - 50) { // Left swipe
                const nextIndex = Math.min(pages.length - 1, currentIndex + 1);
                if (currentIndex !== nextIndex) navigateTo(pages[nextIndex]);
            }
            if (touchendX > touchstartX + 50) { // Right swipe
                const prevIndex = Math.max(0, currentIndex - 1);
                if (currentIndex !== prevIndex) navigateTo(pages[prevIndex]);
            }
        }
        
        /**
         * ページ遷移を実行する関数（最終修正版）
         * @param {string} pageId - 遷移先のページID
         */
        function navigateTo(pageId) {
            if (currentPage === pageId || isNavigating) return;
            isNavigating = true;

            const currentPageEl = document.getElementById(currentPage);
            const nextPageEl = document.getElementById(pageId);
            const navButtons = document.querySelectorAll('.nav-btn');

            if (!currentPageEl || !nextPageEl) {
                isNavigating = false;
                return;
            }

            const pageOrder = ['main-page', 'schedule-page', 'map-page', 'weather-page', 'route-page', 'settings-page'];
            const currentPageIndex = pageOrder.indexOf(currentPage);
            const nextPageIndex = pageOrder.indexOf(pageId);
            const isForward = nextPageIndex > currentPageIndex;

            // アニメーション完了後に実行されるクリーンアップ処理
            const onTransitionEnd = () => {
                nextPageEl.removeEventListener('transitionend', onTransitionEnd);
                
                // 古いページで意図しないアニメーションが起きないよう、一時的にtransitionを無効化
                currentPageEl.style.transition = 'none';
                
                // 古いページの状態を完全にリセット
                currentPageEl.classList.remove('page-active', 'page-leave', 'page-leave-reverse');
                currentPageEl.classList.add('page-enter'); // デフォルトの画面外（右）状態に戻す
                
                // ブラウザにスタイル変更を即時反映させるためのハック
                currentPageEl.offsetHeight; 
                
                // transitionを元に戻して、次のアニメーションに備える
                currentPageEl.style.transition = '';
                // === ここまでが修正箇所 ===

                // グローバルな状態を更新
                currentPage = pageId;
                isNavigating = false;
            };
            nextPageEl.addEventListener('transitionend', onTransitionEnd);

            // 次のページを開始位置にセット
            nextPageEl.classList.remove('page-enter', 'page-enter-reverse');
            nextPageEl.classList.add(isForward ? 'page-enter' : 'page-enter-reverse');
            
            // アニメーションを開始
            requestAnimationFrame(() => {
                currentPageEl.classList.add(isForward ? 'page-leave' : 'page-leave-reverse');
                currentPageEl.classList.remove('page-active');
                nextPageEl.classList.remove('page-enter', 'page-enter-reverse');
                nextPageEl.classList.add('page-active');
            });

            // ナビゲーションボタンのスタイルを更新
            navButtons.forEach(btn => {
                btn.classList.toggle('text-yellow-400', btn.dataset.page === pageId);
                btn.classList.toggle('text-white/80', btn.dataset.page !== pageId);
            });
        }


        async function addEvent() {
            const title = document.getElementById('event-title').value;
            const start = document.getElementById('event-start').value;
            const end = document.getElementById('event-end').value;
            const type = document.getElementById('event-type').value;
            const details = document.getElementById('event-details').value;

            if (!title || !start || !end) {
                await showModal('タイトル、開始時刻、終了時刻は必須です。'); return;
            }
            schedule.push({ id: Date.now(), title, start, end, type, details });
            saveData();
            renderAll();
            document.getElementById('event-title').value = '';
            document.getElementById('event-start').value = '';
            document.getElementById('event-end').value = '';
            document.getElementById('event-details').value = '';
            navigateTo('main-page');
        }

        async function deleteEvent(e) {
            const confirmed = await showModal('この予定を削除しますか？', true);
            if (confirmed) {
                const eventId = parseInt(e.currentTarget.dataset.id);
                schedule = schedule.filter(event => event.id !== eventId);
                saveData(); renderAll();
            }
        }

        async function saveSettings() {
            googleApiKey = document.getElementById('api-key-input').value;
            googleMapUrl = document.getElementById('gmap-url-input').value;
            weatherLocation = document.getElementById('weather-location-input').value;
            initGoogleMaps();
            saveData(); 
            renderMap();
            await showModal('設定を保存しました。'); navigateTo('main-page');
        }

        async function searchRoute() {
            if (!googleApiKey || typeof google === 'undefined' || !directionsService) {
                await showModal('Google Maps APIキーが設定されていないか、読み込まれていません。設定ページでキーを設定してください。'); 
                navigateTo('settings-page'); 
                return;
            }
            const origin = document.getElementById('origin').value;
            const destination = document.getElementById('destination').value;
            if (!origin || !destination) {
                await showModal('出発地と目的地を入力してください。'); return;
            }
            
            const resultsContainer = document.getElementById('route-results-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            resultsContainer.innerHTML = '';
            loadingIndicator.classList.remove('hidden');

            const payload = {
                origin: origin,
                destination: destination,
                travelMode: 'TRANSIT',
                provideRouteAlternatives: true
            };
            
            try {
                // DirectionsService APIはAPIキーを必要とするため、Google Maps APIをロードする
                directionsService.route(payload, async (result, status) => {
                    loadingIndicator.classList.add('hidden');
                    if (status == 'OK') {
                        result.routes.slice(0, 3).forEach((route, index) => {
                            const leg = route.legs[0];
                            const summary = leg.steps.filter(s => s.travel_mode === 'TRANSIT').map(s => s.transit.line.name).join(' → ');
                            const card = document.createElement('div');
                            card.className = 'bg-white/20 p-3 rounded-lg cursor-pointer hover:bg-white/30';
                            card.innerHTML = `<div class="flex justify-between items-center"><p class="font-bold text-lg">候補 ${index + 1} <span class="text-sm font-normal">(${leg.duration.text})</span></p><p class="font-bold">${leg.departure_time.text} → ${leg.arrival_time.text}</p></div><p class="text-sm opacity-90 truncate">${summary}</p>`;
                            card.addEventListener('click', async () => {
                                const confirmed = await showModal(`予定を追加しますか？\n${origin} → ${destination}`, true);
                                if (confirmed) {
                                    schedule.push({ id: Date.now(), title: `${origin} → ${destination}`, start: leg.departure_time.text.replace(/am|pm/i, '').trim(), end: leg.arrival_time.text.replace(/am|pm/i, '').trim(), type: 'fas fa-route', details: summary });
                                    saveData(); renderAll(); navigateTo('schedule-page');
                                }
                            });
                            resultsContainer.appendChild(card);
                        });
                    } else {
                        resultsContainer.innerHTML = `<p class="text-center text-red-400">ルートが見つかりませんでした。(エラー: ${status})</p>`;
                    }
                });
            } catch (error) {
                loadingIndicator.classList.add('hidden');
                console.error("Directions API call failed:", error);
                await showModal('ルート検索中にエラーが発生しました。設定を確認してください。');
            }
        }
        
        async function loadWeatherByLocation(location, isCurrentLocation = false) {
            const iframe = document.getElementById('windy-iframe');
            const placeholder = document.getElementById('weather-placeholder');
            const placeholderText = document.getElementById('weather-placeholder-text');
            
            // ローディング表示に切り替え
            placeholderText.innerHTML = `<i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>天気予報を読み込み中...</p>`;
            placeholder.classList.remove('hidden');

            let lat = 0;
            let lon = 0;
            let detailLat = 0;
            let detailLon = 0;

            if (isCurrentLocation) {
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject);
                        });
                        lat = position.coords.latitude;
                        lon = position.coords.longitude;
                        detailLat = lat;
                        detailLon = lon;
                    } catch (error) {
                        console.error('Geolocation error:', error);
                        await showModal('位置情報の取得に失敗しました。ブラウザの設定で位置情報の利用を許可しているか確認してください。');
                        placeholderText.innerHTML = `位置情報の取得に失敗しました。<br>設定地点の天気予報を表示してください。`;
                        return;
                    }
                } else {
                    console.log('Geolocation is not supported by this browser.');
                    await showModal('お使いのブラウザでは現在地情報がサポートされていません。');
                    placeholderText.innerHTML = `お使いのブラウザでは<br>現在地情報がサポートされていません。`;
                    return;
                }
            } else if (location) {
                if (!googleApiKey || typeof google === 'undefined' || !google.maps.Geocoder) {
                    await showModal('Google Maps APIキーが設定されていないか、読み込まれていません。設定ページでキーを設定してください。'); 
                    navigateTo('settings-page');
                    return;
                }
                
                try {
                    const { results } = await geocoder.geocode({ address: location });
                    if (results.length > 0) {
                        const { lat: gLat, lng: gLng } = results[0].geometry.location;
                        lat = gLat();
                        lon = gLng();
                        detailLat = lat;
                        detailLon = lon;
                    } else {
                        await showModal('指定された地点が見つかりませんでした。');
                        placeholderText.innerHTML = `指定された地点が見つかりませんでした。<br>別の地点を試してください。`;
                        return;
                    }
                } catch (error) {
                    console.error('Geocoder API call failed:', error);
                    await showModal('地点の検索中にエラーが発生しました。設定を確認してください。');
                    placeholderText.innerHTML = `地点の検索中にエラーが発生しました。<br>設定を確認してください。`;
                    return;
                }
            } else {
                await showModal('天気予報を表示する地点が設定されていません。');
                placeholderText.innerHTML = `天気予報を表示する地点が<br>設定されていません。`;
                return;
            }

            const src = `https://embed.windy.com/embed.html?type=map&location=coordinates&metricRain=mm&metricTemp=%C2%B0C&metricWind=m/s&zoom=8&overlay=radar&product=radar&level=surface&lat=${lat}&lon=${lon}&detailLat=${detailLat}&detailLon=${detailLon}&detail=true&pressure=true`;
            iframe.src = src;
            iframe.onload = () => {
                placeholder.classList.add('hidden');
            };
        }
    </script>
</body>
</html>
